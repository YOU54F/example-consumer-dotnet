# TODO

# name: "can-i-deploy"
# description: "Checks other applications with this tag are compatible with yours"

parameters:
  - name: broker_url # "The url of your pact broker"
  - name: token # "Your pact broker token (required for PactFlow)"
    default: ""
  - name: username # "Your pact broker username"
    default: ""
  - name: password # "Your pact broker password"
    default: ""
  - name: application_name # "The name of your application (usually project name)"
    default: false
  - name: version # "The version of your application (defaults to version of the code where the action is run from)"
    default: ""
  - name: latest # "The latest tag value of your application (i.e. 'test' or 'stage')"
    default: ""
  - name: to_environment # "The environment you wish to deploy to (test / stage / prod etc...)"
    default: ""
  - name: to # "The tag you wish to deploy to (test / stage / prod etc...)"
    default: ""
  - name: dry_run # "When dry-run is enabled, always exit process with a success code."
    type: boolean
    default: false
  - name: branch # "The branch of the version for which you want to check the verification results."
    default: ""
  - name: main_branch # "Use the latest version of the configured main branch of the pacticipant as the version for which you want to check the verification results. Default: false"
    type: boolean
    default: false
  - name: retry_while_unknown
    default: 0
    type: number
    #   Optional (default 0): the number of times to retry while there is an unknown
    #   verification result (ie. the provider verification is likely still running)
  - name: retry_interval
    #   Optional (default 10): The time between retries in seconds.
    #   Use in conjunction with --retry-while-unknown
    default: 10
    type: number
steps:
- script: |
    ./templates/scripts/canideployTo.sh
  displayName: Can I Deploy
  env: 
    PACT_BROKER_BASE_URL: ${{ coalesce(parameters.broker_url, variables.PACT_BROKER_BASE_URL) }}
    PACT_BROKER_TOKEN: ${{ coalesce(parameters.token, variables.PACT_BROKER_TOKEN) }}
    PACT_BROKER_USERNAME: ${{ coalesce(parameters.username, variables.PACT_BROKER_USERNAME) }}
    PACT_BROKER_PASSWORD: ${{ coalesce(parameters.password, variables.PACT_BROKER_PASSWORD) }}
    COMMIT: ${{ coalesce(parameters.version, variables.COMMIT) }}
    application_name: ${{ coalesce(parameters.application_name || variables.application_name }}
    to_environment: ${{ coalesce(parameters.to_environment || variables.to_environment }}
    to: ${{ coalesce(parameters.to || variables.to }}
    latest: ${{ parameters.latest }}
    retry_while_unknown: ${{ coalesce(parameters.retry_while_unknown || variables.retry_while_unknown }}
    retry_interval: ${{ coalesce(parameters.retry_interval || variables.retry_interval }}
    dry_run: ${{ parameters.dry_run }}
    branch: ${{ parameters.branch }}
    main_branch: ${{ parameters.main_branch }}
